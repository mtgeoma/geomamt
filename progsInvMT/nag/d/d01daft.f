      SUBROUTINE D01DAF(YA,YB,PHI1,PHI2,F,ABSACC,ANS,NPTS,IFAIL)
C
C     EVALUATES A DOUBLE INTEGRAL BY REPEATED APPLICATIONS
C     OF PATTERSON'S METHOD.
C     NAG COPYRIGHT 1975
C     MARK 5 RELEASE
C     MARK 7 REVISED IER-138 (DEC 1978)
C     MARK 11.5(F77) REVISED. (SEPT 1985.)
C     .. Parameters ..
      CHARACTER*6       SRNAME
      PARAMETER         (SRNAME='D01DAF')
C     .. Scalar Arguments ..
      DOUBLE PRECISION  ABSACC, ANS, YA, YB
      INTEGER           IFAIL, NPTS
C     .. Function Arguments ..
      DOUBLE PRECISION  F, PHI1, PHI2
      EXTERNAL          F, PHI1, PHI2
C     .. Local Scalars ..
      DOUBLE PRECISION  ACUM, ACUMX, ANSX, DIFF, DIFFX, EST, ESTX, FF,
     *                  FZERO, FZEROX, SUM, SUMX, X, XA, XB, XX, Y
      INTEGER           I, IERROR, INEW, INEWX, IOLD, IOLDX, IX, J, JX,
     *                  NF
C     .. Local Arrays ..
      DOUBLE PRECISION  FUNCT(127), FUNCTX(127), P(381)
      CHARACTER*1       P01REC(1)
C     .. External Functions ..
      INTEGER           P01ABF
      EXTERNAL          P01ABF
C     .. Intrinsic Functions ..
      INTRINSIC         ABS
C     .. Data statements ..
      DATA              P(1), P(2), P(3), P(4), P(5), P(6), P(7), P(8),
     *                  P(9), P(10), P(11), P(12), P(13), P(14), P(15),
     *                  P(16), P(17), P(18), P(19), P(20), P(21), P(22),
     *                  P(23), P(24), P(25), P(26), P(27),
     *                  P(28)/
     *     0.7745966692414834D+00,    0.5555555555555556D+00,
     *     0.8888888888888889D+00,    0.2684880898683334D+00,
     *     0.9604912687080203D+00,    0.1046562260264673D+00,
     *     0.4342437493468026D+00,    0.4013974147759622D+00,
     *     0.4509165386584741D+00,    0.1344152552437842D+00,
     *     0.5160328299707974D-01,    0.2006285293769890D+00,
     *     0.9938319632127550D+00,    0.1700171962994026D-01,
     *     0.8884592328722570D+00,    0.9292719531512454D-01,
     *     0.6211029467372264D+00,    0.1715119091363914D+00,
     *     0.2233866864289669D+00,    0.2191568584015875D+00,
     *     0.2255104997982067D+00,    0.6720775429599070D-01,
     *     0.2580759809617665D-01,    0.1003142786117956D+00,
     *     0.8434565739321106D-02,    0.4646289326175799D-01,
     *     0.8575592004999035D-01,    0.1095784210559246D+00/
      DATA              P(29), P(30), P(31), P(32), P(33), P(34), P(35),
     *                  P(36), P(37), P(38), P(39), P(40), P(41), P(42),
     *                  P(43), P(44), P(45), P(46), P(47), P(48), P(49),
     *                  P(50), P(51), P(52), P(53), P(54), P(55),
     *                  P(56)/
     *     0.9990981249676676D+00,    0.2544780791561874D-02,
     *     0.9815311495537401D+00,    0.1644604985438781D-01,
     *     0.9296548574297401D+00,    0.3595710330712932D-01,
     *     0.8367259381688687D+00,    0.5697950949412336D-01,
     *     0.7024962064915271D+00,    0.7687962049900353D-01,
     *     0.5313197436443756D+00,    0.9362710998126447D-01,
     *     0.3311353932579768D+00,    0.1056698935802348D+00,
     *     0.1124889431331866D+00,    0.1119568730209535D+00,
     *     0.1127552567207687D+00,    0.3360387714820773D-01,
     *     0.1290380010035127D-01,    0.5015713930589954D-01,
     *     0.4217630441558855D-02,    0.2323144663991027D-01,
     *     0.4287796002500773D-01,    0.5478921052796287D-01,
     *     0.1265156556230068D-02,    0.8223007957235930D-02,
     *     0.1797855156812827D-01,    0.2848975474583355D-01/
      DATA              P(57), P(58), P(59), P(60), P(61), P(62), P(63),
     *                  P(64), P(65), P(66), P(67), P(68), P(69), P(70),
     *                  P(71), P(72), P(73), P(74), P(75), P(76), P(77),
     *                  P(78), P(79), P(80), P(81), P(82), P(83),
     *                  P(84)/
     *     0.3843981024945553D-01,    0.4681355499062801D-01,
     *     0.5283494679011652D-01,    0.5597843651047632D-01,
     *     0.9998728881203576D+00,    0.3632214818455307D-03,
     *     0.9972062593722220D+00,    0.2579049794685688D-02,
     *     0.9886847575474295D+00,    0.6115506822117246D-02,
     *     0.9721828747485818D+00,    0.1049824690962132D-01,
     *     0.9463428583734029D+00,    0.1540675046655950D-01,
     *     0.9103711569570043D+00,    0.2059423391591271D-01,
     *     0.8639079381936905D+00,    0.2586967932721475D-01,
     *     0.8069405319502176D+00,    0.3107355111168796D-01,
     *     0.7397560443526948D+00,    0.3606443278078257D-01,
     *     0.6629096600247806D+00,    0.4071551011694432D-01,
     *     0.5771957100520458D+00,    0.4491453165363220D-01,
     *     0.4836180269458410D+00,    0.4856433040667320D-01/
      DATA              P(85), P(86), P(87), P(88), P(89), P(90), P(91),
     *                  P(92), P(93), P(94), P(95), P(96), P(97), P(98),
     *                  P(99), P(100), P(101), P(102), P(103), P(104),
     *                  P(105), P(106), P(107), P(108), P(109), P(110),
     *                  P(111), P(112)/
     *     0.3833593241987303D+00,    0.5158325395204846D-01,
     *     0.2777498220218243D+00,    0.5390549933526606D-01,
     *     0.1682352515522075D+00,    0.5548140435655936D-01,
     *     0.5634431304659279D-01,    0.5627769983125430D-01,
     *     0.5637762836038472D-01,    0.1680193857410387D-01,
     *     0.6451900050175737D-02,    0.2507856965294977D-01,
     *     0.2108815245726633D-02,    0.1161572331995513D-01,
     *     0.2143898001250387D-01,    0.2739460526398143D-01,
     *     0.6326073193626335D-03,    0.4111503978654693D-02,
     *     0.8989275784064136D-02,    0.1424487737291677D-01,
     *     0.1921990512472777D-01,    0.2340677749531401D-01,
     *     0.2641747339505826D-01,    0.2798921825523816D-01,
     *     0.1807395644453884D-03,    0.1289524082610417D-02,
     *     0.3057753410175531D-02,    0.5249123454808859D-02/
      DATA              P(113), P(114), P(115), P(116), P(117), P(118),
     *                  P(119), P(120), P(121), P(122), P(123), P(124),
     *                  P(125), P(126), P(127), P(128), P(129), P(130),
     *                  P(131), P(132), P(133), P(134), P(135), P(136),
     *                  P(137), P(138), P(139), P(140)/
     *     0.7703375233279742D-02,    0.1029711695795636D-01,
     *     0.1293483966360737D-01,    0.1553677555584398D-01,
     *     0.1803221639039129D-01,    0.2035775505847216D-01,
     *     0.2245726582681610D-01,    0.2428216520333660D-01,
     *     0.2579162697602423D-01,    0.2695274966763303D-01,
     *     0.2774070217827968D-01,    0.2813884991562715D-01,
     *     0.9999824303548916D+00,    0.5053609520786252D-04,
     *     0.9995987996719107D+00,    0.3777466463269847D-03,
     *     0.9983166353184074D+00,    0.9383698485423815D-03,
     *     0.9957241046984072D+00,    0.1681142865421470D-02,
     *     0.9914957211781061D+00,    0.2568764943794020D-02,
     *     0.9853714995985204D+00,    0.3572892783517300D-02,
     *     0.9771415146397057D+00,    0.4671050372114322D-02,
     *     0.9666378515584166D+00,    0.5843449875835640D-02/
      DATA              P(141), P(142), P(143), P(144), P(145), P(146),
     *                  P(147), P(148), P(149), P(150), P(151), P(152),
     *                  P(153), P(154), P(155), P(156), P(157), P(158),
     *                  P(159), P(160), P(161), P(162), P(163), P(164),
     *                  P(165), P(166), P(167), P(168)/
     *     0.9537300064257611D+00,    0.7072489995433555D-02,
     *     0.9383203977795929D+00,    0.8342838753968158D-02,
     *     0.9203400254700124D+00,    0.9641177729702537D-02,
     *     0.8997448997769400D+00,    0.1095573338783790D-01,
     *     0.8765134144847053D+00,    0.1227583056008277D-01,
     *     0.8506444947683503D+00,    0.1359157100976555D-01,
     *     0.8221562543649804D+00,    0.1489364166481518D-01,
     *     0.7910849337998484D+00,    0.1617321872957772D-01,
     *     0.7574839663805136D+00,    0.1742193015946417D-01,
     *     0.7214230853700989D+00,    0.1863184825613879D-01,
     *     0.6829874310910792D+00,    0.1979549504809750D-01,
     *     0.6422766425097595D+00,    0.2090585144581202D-01,
     *     0.5994039302422429D+00,    0.2195636630531782D-01,
     *     0.5544951326319325D+00,    0.2294096422938775D-01/
      DATA              P(169), P(170), P(171), P(172), P(173), P(174),
     *                  P(175), P(176), P(177), P(178), P(179), P(180),
     *                  P(181), P(182), P(183), P(184), P(185), P(186),
     *                  P(187), P(188), P(189), P(190), P(191), P(192),
     *                  P(193), P(194), P(195), P(196)/
     *     0.5076877575337166D+00,    0.2385405210603854D-01,
     *     0.4591300119898323D+00,    0.2469052474448768D-01,
     *     0.4089798212298887D+00,    0.2544576996546477D-01,
     *     0.3574038378315322D+00,    0.2611567337670610D-01,
     *     0.3045764415567140D+00,    0.2669662292745036D-01,
     *     0.2506787303034832D+00,    0.2718551322962479D-01,
     *     0.1958975027111002D+00,    0.2757974956648187D-01,
     *     0.1404242331525602D+00,    0.2787725147661370D-01,
     *     0.8445404008371088D-01,    0.2807645579381725D-01,
     *     0.2818464894974569D-01,    0.2817631903301660D-01,
     *     0.2818881418019236D-01,    0.8400969287051933D-02,
     *     0.3225950025087868D-02,    0.1253928482647488D-01,
     *     0.1054407622853764D-02,    0.5807861659977567D-02,
     *     0.1071949000625193D-01,    0.1369730263199072D-01/
      DATA              P(197), P(198), P(199), P(200), P(201), P(202),
     *                  P(203), P(204), P(205), P(206), P(207), P(208),
     *                  P(209), P(210), P(211), P(212), P(213), P(214),
     *                  P(215), P(216), P(217), P(218), P(219), P(220),
     *                  P(221), P(222), P(223), P(224)/
     *     0.3163038905577009D-03,    0.2055751989327344D-02,
     *     0.4494637892032068D-02,    0.7122438686458387D-02,
     *     0.9609952562363883D-02,    0.1170338874765700D-01,
     *     0.1320873669752913D-01,    0.1399460912761908D-01,
     *     0.9059242831838712D-04,    0.6447620408298260D-03,
     *     0.1528876705087616D-02,    0.2624561727404430D-02,
     *     0.3851687616639871D-02,    0.5148558478978178D-02,
     *     0.6467419831803687D-02,    0.7768387777921991D-02,
     *     0.9016108195195643D-02,    0.1017887752923608D-01,
     *     0.1122863291340805D-01,    0.1214108260166830D-01,
     *     0.1289581348801211D-01,    0.1347637483381652D-01,
     *     0.1387035108913984D-01,    0.1406942495781358D-01,
     *     0.2234303854547696D-04,    0.1888639812523945D-03,
     *     0.4691849097155527D-03,    0.8405714326197546D-03/
      DATA              P(225), P(226), P(227), P(228), P(229), P(230),
     *                  P(231), P(232), P(233), P(234), P(235), P(236),
     *                  P(237), P(238), P(239), P(240), P(241), P(242),
     *                  P(243), P(244), P(245), P(246), P(247), P(248),
     *                  P(249), P(250), P(251), P(252)/
     *     0.1284382471895813D-02,    0.1786446391758630D-02,
     *     0.2335525186057160D-02,    0.2921724937917820D-02,
     *     0.3536244997716778D-02,    0.4171419376984079D-02,
     *     0.4820588864851268D-02,    0.5477866693918951D-02,
     *     0.6137915280041385D-02,    0.6795785504882773D-02,
     *     0.7446820832407591D-02,    0.8086609364788860D-02,
     *     0.8710965079732087D-02,    0.9315924128069395D-02,
     *     0.9897747524048750D-02,    0.1045292572290601D-01,
     *     0.1097818315265891D-01,    0.1147048211469387D-01,
     *     0.1192702605301927D-01,    0.1234526237224384D-01,
     *     0.1272288498273238D-01,    0.1305783668835305D-01,
     *     0.1334831146372518D-01,    0.1359275661481240D-01,
     *     0.1378987478324094D-01,    0.1393862573830685D-01,
     *     0.1403822789690862D-01,    0.1408815951650830D-01/
      DATA              P(253), P(254), P(255), P(256), P(257), P(258),
     *                  P(259), P(260), P(261), P(262), P(263), P(264),
     *                  P(265), P(266), P(267), P(268), P(269), P(270),
     *                  P(271), P(272), P(273), P(274), P(275), P(276),
     *                  P(277), P(278), P(279), P(280)/
     *     0.9999958664005165D+00,    0.8822702694609804D-05,
     *     0.9999445736539534D+00,    0.5403992347935378D-04,
     *     0.9997604612201292D+00,    0.1357078405902732D-03,
     *     0.9993803390481119D+00,    0.2492143139346697D-03,
     *     0.9987456144372444D+00,    0.3897452481631715D-03,
     *     0.9978053544968644D+00,    0.5542953186526136D-03,
     *     0.9965141459148629D+00,    0.7402828044420028D-03,
     *     0.9948315028006219D+00,    0.9453615168885046D-03,
     *     0.9927213442827886D+00,    0.1167484117433308D-02,
     *     0.9901513704007702D+00,    0.1404907995655566D-02,
     *     0.9870925279540341D+00,    0.1656112728154507D-02,
     *     0.9835186575786327D+00,    0.1919712971013880D-02,
     *     0.9794062816708627D+00,    0.2194406925363840D-02,
     *     0.9747344597524027D+00,    0.2478958226657568D-02/
      DATA              P(281), P(282), P(283), P(284), P(285), P(286),
     *                  P(287), P(288), P(289), P(290), P(291), P(292),
     *                  P(293), P(294), P(295), P(296), P(297), P(298),
     *                  P(299), P(300), P(301), P(302), P(303), P(304),
     *                  P(305), P(306), P(307), P(308)/
     *     0.9694846595024592D+00,    0.2772195764593451D-02,
     *     0.9636406215698121D+00,    0.3073018434702578D-02,
     *     0.9571882161098610D+00,    0.3380397991086920D-02,
     *     0.9501152975212949D+00,    0.3693377917025651D-02,
     *     0.9424115651910831D+00,    0.4011068724075023D-02,
     *     0.9340684361577258D+00,    0.4332640968092983D-02,
     *     0.9250789329070757D+00,    0.4657317299756855D-02,
     *     0.9154375871557650D+00,    0.4984364564765539D-02,
     *     0.9051403588132616D+00,    0.5313086605187057D-02,
     *     0.8941845683355590D+00,    0.5642818101384444D-02,
     *     0.8825688402473419D+00,    0.5972919565508166D-02,
     *     0.8702930555481139D+00,    0.6302773449085759D-02,
     *     0.8573583108862322D+00,    0.6631781242901888D-02,
     *     0.8437668826727086D+00,    0.6959361409390423D-02/
      DATA              P(309), P(310), P(311), P(312), P(313), P(314),
     *                  P(315), P(316), P(317), P(318), P(319), P(320),
     *                  P(321), P(322), P(323), P(324), P(325), P(326),
     *                  P(327), P(328), P(329), P(330), P(331), P(332),
     *                  P(333), P(334), P(335), P(336)/
     *     0.8295221946374014D+00,    0.7284947980553807D-02,
     *     0.8146287876551374D+00,    0.7607989665719057D-02,
     *     0.7990922909608414D+00,    0.7927949334294849D-02,
     *     0.7829193941182830D+00,    0.8244303763032868D-02,
     *     0.7661178193037601D+00,    0.8556543561307690D-02,
     *     0.7486962936169366D+00,    0.8864173209482494D-02,
     *     0.7306645212421813D+00,    0.9166711163560788D-02,
     *     0.7120331553622520D+00,    0.9463689993830065D-02,
     *     0.6928137697791147D+00,    0.9754656536317411D-02,
     *     0.6730188302304185D+00,    0.1003917204405684D-01,
     *     0.6526616654100175D+00,    0.1031681233094762D-01,
     *     0.6317564377111942D+00,    0.1058716790488520D-01,
     *     0.6103181137151864D+00,    0.1084984408933731D-01,
     *     0.5883624344476625D+00,    0.1110446113400693D-01/
      DATA              P(337), P(338), P(339), P(340), P(341), P(342),
     *                  P(343), P(344), P(345), P(346), P(347), P(348),
     *                  P(349), P(350), P(351), P(352), P(353), P(354),
     *                  P(355), P(356), P(357), P(358), P(359), P(360),
     *                  P(361), P(362), P(363), P(364)/
     *     0.5659058854236544D+00,    0.1135065431598060D-01,
     *     0.5429656664983115D+00,    0.1158807403304395D-01,
     *     0.5195596615374570D+00,    0.1181638589083024D-01,
     *     0.4957064079187615D+00,    0.1203527078527956D-01,
     *     0.4714250658716589D+00,    0.1224442498161199D-01,
     *     0.4467353876620285D+00,    0.1244356019071404D-01,
     *     0.4216576866261633D+00,    0.1263240364354208D-01,
     *     0.3962128060576159D+00,    0.1281069816387736D-01,
     *     0.3704220879500782D+00,    0.1297820223953740D-01,
     *     0.3443073415994380D+00,    0.1313469009196015D-01,
     *     0.3178908120684767D+00,    0.1327995174393053D-01,
     *     0.2911951485182467D+00,    0.1341379308511010D-01,
     *     0.2642433724109268D+00,    0.1353603593495621D-01,
     *     0.2370588455898297D+00,    0.1364651810257129D-01/
      DATA              P(365), P(366), P(367), P(368), P(369), P(370),
     *                  P(371), P(372), P(373), P(374), P(375), P(376),
     *                  P(377), P(378), P(379), P(380), P(381)/
     *     0.2096652382431812D+00,    0.1374509344300190D-01,
     *     0.1820864967592522D+00,    0.1383163190950643D-01,
     *     0.1543468114813781D+00,    0.1390601960132546D-01,
     *     0.1264705843723020D+00,    0.1396815880651694D-01,
     *     0.9848239659811920D-01,    0.1401796803945661D-01,
     *     0.7040697604285518D-01,    0.1405538207264996D-01,
     *     0.4226916476536360D-01,    0.1408035196255366D-01,
     *     0.1409388641078246D-01,    0.1409284506916041D-01,
     *     0.1409440709009618D-01/
C     .. Executable Statements ..
C
C     CALCULATION OF OUTER INTEGRAL.
      IERROR = 0
      NPTS = 0
      IF (YA-YB) 20, 240, 20
   20 SUM = (YB+YA)*0.5D0
      DIFF = (YB-YA)*0.5D0
      NF = 1
      Y = SUM
      GO TO 320
C
C     1-POINT GAUSS.
   40 FZERO = ANSX
      EST = (FZERO+FZERO)*DIFF
      I = 0
      IOLD = 0
      INEW = 1
      ACUM = 0.0D0
      GO TO 100
   60 ACUM = 0.0D0
C
C     CONTRIBUTION FROM FUNCTION VALUES ALREADY COMPUTED.
      DO 80 J = 1, IOLD
         I = I + 1
         ACUM = ACUM + P(I)*FUNCT(J)
   80 CONTINUE
C
C     CONTRIBUTION FROM NEW FUNCTION VALUES.
  100 IOLD = IOLD + INEW
      J = INEW
  120 I = I + 1
      X = P(I)*DIFF
      NF = 2
      Y = SUM + X
      GO TO 320
  140 FF = ANSX
      NF = 3
      Y = SUM - X
      GO TO 320
  160 FUNCT(J) = FF + ANSX
      I = I + 1
      ACUM = ACUM + P(I)*FUNCT(J)
      J = J + 1
      IF (J.LE.IOLD) GO TO 120
      INEW = IOLD + 1
      I = I + 1
      ANS = (ACUM+P(I)*FZERO)*DIFF
C
C     CHECK FOR CONVERGENCE.
      IF (ABS(ANS-EST)-ABSACC) 260, 260, 180
  180 IF (IOLD-127) 200, 220, 220
  200 EST = ANS
      GO TO 60
  220 IERROR = IERROR + 1
      IFAIL = P01ABF(IFAIL,IERROR,SRNAME,0,P01REC)
      RETURN
  240 ANS = 0.0D0
  260 IF (IERROR) 280, 300, 280
  280 IFAIL = P01ABF(IFAIL,IERROR,SRNAME,0,P01REC)
      RETURN
  300 IFAIL = 0
      RETURN
C
C     CALCULATION OF INNER INTEGRAL BEGINS HERE.
  320 XA = PHI1(Y)
      XB = PHI2(Y)
      IF (XA-XB) 340, 520, 340
  340 SUMX = (XB+XA)*0.5D0
      DIFFX = (XB-XA)*0.5D0
      FZEROX = F(SUMX,Y)
      ESTX = (FZEROX+FZEROX)*DIFFX
      IX = 0
      IOLDX = 0
      INEWX = 1
      ACUMX = 0.0D0
      GO TO 400
  360 ACUMX = 0.0D0
      DO 380 JX = 1, IOLDX
         IX = IX + 1
         ACUMX = ACUMX + P(IX)*FUNCTX(JX)
  380 CONTINUE
  400 IOLDX = IOLDX + INEWX
      DO 420 JX = INEWX, IOLDX
         IX = IX + 1
         XX = P(IX)*DIFFX
         FUNCTX(JX) = F(SUMX+XX,Y) + F(SUMX-XX,Y)
         IX = IX + 1
         ACUMX = ACUMX + P(IX)*FUNCTX(JX)
  420 CONTINUE
      INEWX = IOLDX + 1
      IX = IX + 1
      ANSX = (ACUMX+P(IX)*FZEROX)*DIFFX
      IF (ABS(ANSX-ESTX)-ABSACC) 500, 500, 440
  440 IF (IOLDX-127) 460, 480, 480
  460 ESTX = ANSX
      GO TO 360
  480 NPTS = NPTS + INEWX + IOLDX
      IERROR = IERROR + 10
      GO TO (40,140,160) NF
  500 NPTS = NPTS + INEWX + IOLDX
      GO TO (40,140,160) NF
  520 ANSX = 0.0D0
      GO TO (40,140,160) NF
      RETURN
      END
